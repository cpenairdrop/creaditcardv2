<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NextGen Cyber Institute — VIP Verification</title>
  <style>
    /* ===========================
       Basic resets & fonts
       =========================== */
    :root{
      --bg-1:#020617;
      --bg-2:#081028;
      --glass-bg: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.08);
      --gold-1:#ffd54a;
      --gold-2:#d4af37;
      --accent: rgba(255,213,74,0.12);
      --white-glow: rgba(255,255,255,0.12);
      --glass-blur: 10px;
      --card-radius: 14px;
      --vip-glow: 0 0 18px rgba(212,175,55,0.7);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    body{
      background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
      min-height: 100vh;
    }

    /* ===========================
       Animated golden waves (SVG mask + CSS animation)
       =========================== */
    .wave-bg{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      mix-blend-mode:screen;
      opacity:0.95;
    }
    /* create moving gradient waves using pseudo elements */
    .wave-bg .wave{
      position:absolute;
      inset:-10% -20%;
      background: radial-gradient(800px 400px at 10% 20%, rgba(255,215,74,0.08), transparent 10%),
                  radial-gradient(700px 300px at 90% 80%, rgba(212,175,55,0.06), transparent 10%);
      transform: translateX(0);
      animation: drift 20s linear infinite;
      filter: blur(30px) saturate(1.3);
    }
    .wave-bg .wave.wave2{
      transform: translateX(-10%);
      opacity:0.7;
      animation-duration: 28s;
      animation-direction: reverse;
      filter: blur(40px) saturate(1.2);
    }
    @keyframes drift {
      0%{transform: translateX(-8%) translateY(0) rotate(-2deg)}
      50%{transform: translateX(8%) translateY(2%) rotate(2deg)}
      100%{transform: translateX(-8%) translateY(0) rotate(-2deg)}
    }

    /* faint watermark text */
    .watermark{
      position:fixed;
      top:12%;
      right:6%;
      transform:rotate(-18deg);
      font-size:64px;
      color: rgba(255,255,255,0.03);
      font-weight:800;
      letter-spacing:6px;
      z-index:0;
      pointer-events:none;
    }

    /* ===========================
       Center container & card
       =========================== */
    .wrap{
      position:relative;
      z-index:2;
      min-height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:32px;
    }

    .card{
      width:100%;
      max-width:980px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:var(--card-radius);
      border:1px solid var(--glass-border);
      padding:22px;
      box-shadow: 0 10px 40px rgba(2,6,23,0.6);
      backdrop-filter: blur(var(--glass-blur));
      position:relative;
      overflow:hidden;
    }

    header.card-header{
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:12px;
    }
    .logo{
      width:64px;
      height:64px;
      border-radius:12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .brand{
      font-weight:700;
      font-size:20px;
      line-height:1;
    }
    .brand small{display:block; font-weight:600; font-size:12px; color:rgba(255,255,255,0.6); margin-top:4px}

    .vip-badge{
      margin-left:auto;
      padding:6px 12px;
      border-radius:999px;
      background:linear-gradient(90deg,var(--gold-1),var(--gold-2));
      color:#081019;
      font-weight:800;
      box-shadow: var(--vip-glow);
      border:1px solid rgba(255,255,255,0.08);
      letter-spacing:0.6px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }

    /* ===========================
       Lookup form
       =========================== */
    .lookup{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .lookup input[type="text"]{
      flex:1 1 320px;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.25);
      color:#fff;
      outline:none;
      font-size:15px;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.02);
    }
    .btn{
      padding:10px 14px;
      border-radius:10px;
      border: none;
      cursor:pointer;
      font-weight:700;
      letter-spacing:0.4px;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      color:#fff;
      border:1px solid rgba(255,255,255,0.06);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn:active{ transform: translateY(1px) }

    .btn.primary{
      background: linear-gradient(90deg, rgba(212,175,55,0.85), rgba(255,213,74,0.8));
      color:#081019;
      box-shadow: 0 6px 26px rgba(212,175,55,0.12), 0 1px 0 rgba(255,255,255,0.06) inset;
    }
    .btn.ghost{
      background:transparent;
      border:1px dashed rgba(255,255,255,0.06);
    }

    .small{
      font-size:13px;
      color:rgba(255,255,255,0.7);
    }

    /* ===========================
       Result layout
       =========================== */
    .result{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:18px;
      align-items:start;
    }

    .profile, .invoice{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:16px;
      border:1px solid rgba(255,255,255,0.04);
      min-height:180px;
    }

    .profile h3{
      margin:0 0 8px 0;
      font-size:18px;
      display:flex; align-items:center; gap:10px;
    }
    .profile .line{height:1px;background:linear-gradient(90deg, rgba(255,255,255,0.03), transparent); margin:10px 0;}

    .field{
      margin-bottom:8px;
      font-size:14px;
      color:rgba(255,255,255,0.92);
    }
    .field .label{font-weight:700; color:rgba(255,255,255,0.75); display:inline-block; width:120px}
    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      color:#081019;
      background:linear-gradient(90deg,var(--gold-1),var(--gold-2));
      box-shadow: var(--vip-glow);
    }
    .status{
      display:inline-flex; gap:10px; align-items:center; margin-top:6px;
    }
    .status .stat{
      padding:6px 10px; border-radius:8px; font-weight:700; font-size:13px;
    }
    .stat.paid{ background: linear-gradient(90deg,#2ec27e,#1bb06f); color:#02120b }
    .stat.partial{ background: linear-gradient(90deg,#ffb74d,#ff8a4d); color:#1a0b00 }
    .stat.unpaid{ background: linear-gradient(90deg,#ff6b6b,#ff4b4b); color:#1a0303 }

    /* invoice */
    .invoice h4{ margin:0 0 12px 0; font-size:16px; }
    .line-item{
      display:flex; justify-content:space-between; gap:8px; padding:6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.03);
      font-size:14px;
    }
    .line-item:last-child{ border-bottom:none }
    .totals{ font-weight:800; margin-top:10px; display:flex; justify-content:space-between; font-size:15px }
    .balance{ color:#ff6b6b; font-weight:900; }

    /* actions area */
    .actions{ display:flex; flex-direction:column; gap:8px; margin-top:12px }
    .actions .row{ display:flex; gap:8px; flex-wrap:wrap }

    /* typing area */
    .typing{
      min-height:120px;
      font-family: 'Courier New', monospace;
      font-size:15px;
      line-height:1.6;
      color:rgba(255,255,255,0.95);
      white-space:pre-wrap;
      word-break:break-word;
      overflow:hidden;
    }
    .type-gold{ color:var(--gold-1); font-weight:800; text-shadow: 0 0 8px rgba(212,175,55,0.35) }
    .type-white{ color:#fff; }

    /* modal */
    .modal-backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:20;
      backdrop-filter: blur(4px);
    }
    .modal{
      width:calc(100% - 48px);
      max-width:520px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.06);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      transform: translateY(-10px); opacity:0; transition: all .22s ease;
    }
    .modal.show{ transform: translateY(0); opacity:1; }
    .modal h3{ margin:0 0 8px 0 }
    .modal .modal-actions{ display:flex; gap:8px; margin-top:12px; justify-content:flex-end }
    .close-x{ background:transparent; border:none; color:rgba(255,255,255,0.6); font-weight:700; cursor:pointer; }

    /* disabled button look & prevent clicks */
    .btn[disabled]{
      opacity:0.5;
      cursor:not-allowed;
      pointer-events:none;
      filter:grayscale(20%);
    }

    /* responsive */
    @media (max-width:880px){
      .result{ grid-template-columns: 1fr; }
      .invoice{ order:2 }
    }
  </style>
</head>
<body>
  <div class="wave-bg" aria-hidden="true">
    <div class="wave"></div>
    <div class="wave wave2"></div>
  </div>

  <div class="watermark">NEXTGEN CYBER INSTITUTE</div>

  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <header class="card-header">
        <div class="start-date" style="text-align: center; margin-bottom: 20px; color: var(--gold-1); font-weight: bold;">
          <div id="startDate" style="font-size: 24px; text-shadow: 0 0 10px rgba(212,175,55,0.5);"></div>
          <div style="font-size: 14px; margin-top: 5px;">Class Start Date</div>
        </div>
        

        <div class="brand" id="title">
          NextGen Cyber Institute
          <small>VIP Student Verification</small>
        </div>

        <div class="vip-badge" title="VIP">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2l2.1 4.5L19 7l-3.5 3 0.8 4.6L12 11.7 7.7 14.6 8.5 10 5 7l4.9-.5L12 2z" fill="#081019"></path></svg>
          VIP
        </div>
      </header>

      <!-- lookup -->
      <section aria-label="lookup" class="lookup" role="search">
        <input id="emailInput" type="email" placeholder="Enter your email address " aria-label="Email address">
        <button id="searchBtn" class="btn primary">Check Registration</button>
        <button id="resetBtn" class="btn ghost" title="Reset view">Reset</button>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
          <div class="small"></div>
        </div>
      </section>

      <!-- results & typing area -->
      <div id="resultWrap" class="result" aria-live="polite">
        <div class="profile" id="profileCard" style="display:none">
          <h3><span id="vipTitle" class="type-gold"></span></h3>
          <div class="typing" id="typingArea" aria-atomic="true" aria-live="polite"></div>

          <div class="line"></div>
        </div>

        <aside class="invoice" id="invoiceCard" style="display:none">
          <h4>Invoice & Payment</h4>
          <div id="itemsList" aria-hidden="true"></div>
            <div class="totals">
              <div class="balance">Outstanding</div>
              <div id="balanceVal" class="balance">$80</div>
            </div>

          <div style="margin-top:12px;">
            <div class="small" hidden>Payment Ref: <span id="paymentRef">-</span></div>
            <div cl
            ass="small" hidden> Batch: <strong id="batchVal">-</strong></div>
            <div style="height:8px"></div>
            <div id="paymentHistoryArea" class="small"></div>
          </div>
        </aside>
        <!-- moved status and actions to the bottom of the card (last page) -->
      </div>

      <div id="footerControls" style="margin-top:18px;">
        <div class="status" id="statusRow" style="display:none">
          <div id="paidStatus" class="stat paid">PAID</div>
          <div id="partialStatus" class="stat partial" style="display:none">PARTIAL</div>
          <div id="unpaidStatus" class="stat unpaid" style="display:none">UNPAID</div>
        </div>

        <div class="actions" id="actionButtons" style="display:none; margin-top:12px;">
          <div class="row">
            <button id="markPaymentBtn" class="btn" disabled hidden>Mark Payment</button>
            <button id="generateLinkBtn" class="btn primary">Generate Class Private Link</button>
            <button id="copyBtn" class="btn">Copy Info</button>
            <button id="printBtn" class="btn">Print Receipt</button>
            <button id="chatBtn" class="btn">Chat Admin</button>
          </div>
          <div class="row" style="margin-top:6px;">
            <button id="exportBtn" class="btn ghost">Export CSV</button>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="modal" class="modal" role="document">
      <h3 id="modalTitle"></h3>
      <div id="modalBody" style="color:rgba(255,255,255,0.9); margin-top:8px; font-size:15px"></div>
      <div class="modal-actions">
        <button id="modalClose" class="close-x btn">Close</button>
        <button id="modalCopyLink" class="btn primary" style="display:none">Copy Link</button>
      </div>
    </div>
  </div>

  <script>
    /*******************************
     * NextGen Cyber Institute - Single HTML App
     * All logic here. No server, no DB. localStorage persists.
     *******************************/

    console.log("NGCI VIP verification script starting...");

    // Utilities
    const $ = id => document.getElementById(id);
    const formatEmail = (raw) => {
      if(!raw) return '';
      return raw.trim().toLowerCase();
    };

    // localStorage key
    const LS_KEY = 'ngci_registrations_v1';

    // Preloaded dataset with Sanni
    const PRELOAD = [
      {
        phone: "+2347061934493",
        name: "Sanni Ayorinde Isaac",
        email: "sanniisaac3@gmail.com",
        country: "Nigeria",
        gender: "Male",
        laptop: "Yes",
        os: "Windows",
        interest: "Ethical Hacking",
        batch: "NGCVIP202511GH76",
        source: "tiktok",
        paymentRef: "NGCVIP/2025/714",
        items: [
          { description: "Installation of Kali Linux", price: 45, status: "successful", note: "8:30 pm Sat 20/09" },
          { description: "Installation of Parrot OS", price: 0, status: "successful", note: "9:05 pm Sun 28/09" },
          { description: "VPN Installation", price: 40, status: "successful", note: "10:20 pm Tue 30/09" },
          { description: "VIP Ethical Hacking Class", price: 200, status: "partial", note: "4:27 pm Tue 23/09" },
          { description: "Network Adapter", price: 100, status: "pending", note: "Pending payment" }
        ],
        subtotal: 385,
        payments: [
          { date: "2025-10-15", amount: 255, ref: "VIPCLASS-AX9021" }
        ],
        amountPaid: 255,
        balance: 80,
        batchId: "NGCVIP2025GH76",
        vip: true
      }
    ];

    // load dataset - localStorage disabled for privacy; always use in-memory PRELOAD copy
    function loadData(){
      console.log("LocalStorage usage disabled. Using in-memory PRELOAD dataset.");
      // return a deep copy so runtime edits don't mutate the original constant
      return JSON.parse(JSON.stringify(PRELOAD));
    }

    // saveData is a no-op when persistence is disabled
    function saveData(arr){
      console.log("saveData called but persistence is disabled. Changes will not be saved permanently.", arr);
    }

    let db = loadData();

    // DOM refs
    const emailInput = $('emailInput');
    const searchBtn = $('searchBtn');
    const resetBtn = $('resetBtn');
    const profileCard = $('profileCard');
    const invoiceCard = $('invoiceCard');
    const typingArea = $('typingArea');
    const vipTitle = $('vipTitle');
    const actionButtons = $('actionButtons');
    const itemsList = $('itemsList');
    const subtotalVal = $('subtotalVal');
    const paidVal = $('paidVal');
    const balanceVal = $('balanceVal');
    const paymentRef = $('paymentRef');
    const batchVal = $('batchVal');
    const paymentHistoryArea = $('paymentHistoryArea');
    const statusRow = $('statusRow');
    const paidStatus = $('paidStatus');
    const partialStatus = $('partialStatus');
    const unpaidStatus = $('unpaidStatus');

    const markPaymentBtn = $('markPaymentBtn');
    const generateLinkBtn = $('generateLinkBtn');
    const copyBtn = $('copyBtn');
    const printBtn = $('printBtn');
    const chatBtn = $('chatBtn');
    const exportBtn = $('exportBtn');

    // modal refs
    const modalBackdrop = $('modalBackdrop');
    const modal = $('modal');
    const modalTitle = $('modalTitle');
    const modalBody = $('modalBody');
    const modalClose = $('modalClose');
    const modalCopyLink = $('modalCopyLink');

    // typing config
    const TYPING_SPEED = 18; // ms per char
    const BETWEEN_LINES = 220; // ms between lines

    // small debounce to avoid double lookups
    let debounceTimer = null;

    function simulateLookup(email){
      return new Promise((resolve) => {
        console.log("Simulated lookup started for:", email);
        // show spinner by changing button state
        searchBtn.disabled = true;
        searchBtn.textContent = 'Searching...';
        setTimeout(() => {
          const found = db.find(r => r.email.toLowerCase() === email.toLowerCase());
          searchBtn.disabled = false;
          searchBtn.textContent = 'Check Registration';
          console.log("Lookup result for", email, "->", found ? "FOUND" : "NOT FOUND", found || "");
          resolve(found || null);
        }, 2000); // 2s simulated delay
      });
    }

    // --- Typing line-by-line effect ---
    function typeLines(lines, callback){
      typingArea.innerHTML = '';
      let i = 0;
      (function nextLine(){
        if(i >= lines.length){
          if(callback) callback();
          return;
        }
        const {text, cls} = lines[i];
        const lineEl = document.createElement('div');
        lineEl.className = cls === 'gold' ? 'type-gold' : 'type-white';
        typingArea.appendChild(lineEl);
        let j = 0;
        function step(){
          if(j <= text.length){
            lineEl.textContent = text.slice(0,j);
            j++;
            setTimeout(step, TYPING_SPEED);
          }else{
            i++;
            setTimeout(nextLine, BETWEEN_LINES);
          }
        }
        step();
      })();
    }

    // Format dollars
    const dollar = (n) => '$' + Number(n).toLocaleString(undefined, {maximumFractionDigits:2});

    // render user found
    function renderProfile(user){
      vipTitle.textContent = user.vip ? 'NextGenCyber Institute VIP' : 'NextGen Cyber Institute';
      profileCard.style.display = '';
      invoiceCard.style.display = '';
      actionButtons.style.display = '';
      statusRow.style.display = '';

      // status badges
      paidStatus.style.display = 'none';
      partialStatus.style.display = 'none';
      unpaidStatus.style.display = 'none';
      if(user.balance <= 0){
        paidStatus.style.display = '';
      }else if(user.amountPaid > 0){
        partialStatus.style.display = '';
      }else{
        unpaidStatus.style.display = '';
      }

      // typed lines: VIP title gold then details in white lines with spacing
      const lines = [];
      
      // Personal Information
      lines.push({ text: `──── Personal Information ────`, cls: 'gold' });
      lines.push({ text: `Full Name: ${user.name}`, cls: 'white' });
      lines.push({ text: `Email: ${user.email}`, cls: 'white' });
      lines.push({ text: `WhatsApp: ${user.phone}`, cls: 'white' });
      lines.push({ text: `Gender: ${user.gender}`, cls: 'white' });
      
      // Location
      lines.push({ text: `\n──── Location ────`, cls: 'gold' });
      lines.push({ text: `Country: ${user.country}`, cls: 'white' });
      
      // Technical Setup
      lines.push({ text: `\n──── Technical Setup ────`, cls: 'gold' });
      lines.push({ text: `Laptop Available: ${user.laptop}`, cls: 'white' });
      lines.push({ text: `Operating System: ${user.os}`, cls: 'white' });
      
      // Course Details
      lines.push({ text: `\n──── Course Details ────`, cls: 'gold' });
      lines.push({ text: `Interest Area: ${user.interest}`, cls: 'white' });
      lines.push({ text: `Batch: ${user.batch}`, cls: 'white' });
      lines.push({ text: `Source: ${user.source}`, cls: 'white' });
      lines.push({ text: `Payment Reference: ${user.paymentRef}`, cls: 'white' });

      typeLines(lines, () => {
        console.log("Typing animation complete for", user.phone);
      });

      // invoice
      itemsList.innerHTML = '';
      user.items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'line-item';
        const priceText = it.price === 0 ? 'Free' : `<span style="color: #2ec27e; font-weight: bold;">${dollar(it.price)}</span>`;
        let statusColor, statusText, statusSymbol;
        if (it.status === 'pending') {
          statusColor = '#ff6b6b';
          statusText = ' (Pending)';
          statusSymbol = '⏳';
        } else if (it.status === 'partial') {
          statusColor = 'linear-gradient(90deg,#ffb74d,#ff8a4d)';
          statusText = ' (Partial)';
          statusSymbol = '◔';
        } else { // successful
          statusColor = 'linear-gradient(90deg,#2ec27e,#1bb06f)';
          statusText = ' (Successful)';
          statusSymbol = '✓';
        }
        const statusStyle = `background: ${statusColor}; font-weight: bold; margin-left:8px; padding: 2px 8px; border-radius: 4px; color: ${it.status === 'pending' ? '#fff' : '#000'};`;

        const leftHtml = `<div>${it.description}<span style="${statusStyle}">${statusSymbol}${statusText}</span>` + (it.note ? `<div class="small" style="margin-top:6px;color:rgba(255,255,255,0.75)">${it.note}</div>` : '') + `</div>`;
        div.innerHTML = `${leftHtml}<div>${priceText}</div>`;
        itemsList.appendChild(div);
      });

      subtotalVal.textContent = dollar(user.subtotal);
      paidVal.textContent = dollar(user.amountPaid);
      balanceVal.textContent = dollar(user.balance);
      paymentRef.textContent = user.paymentRef || '-';
      batchVal.textContent = user.batch || '-';

      // history
      if(user.payments && user.payments.length){
        paymentHistoryArea.innerHTML = '<strong>Payment History:</strong><br>';
        user.payments.slice().reverse().forEach(p => {
          paymentHistoryArea.innerHTML += `${p.date} — ${dollar(p.amount)} (ref: ${p.ref})<br>`;
        });
      }else{
        paymentHistoryArea.innerHTML = '<strong>Payment History:</strong> None';
      }

      // show/hide action buttons based on status (we show all)
      actionButtons.style.display = 'block';
    }

    // render not found
    function renderNotFound(email){
      profileCard.style.display = '';
      invoiceCard.style.display = 'none';
      actionButtons.style.display = 'none';
      statusRow.style.display = 'none';
      vipTitle.textContent = '';
      typingArea.innerHTML = '';
      typeLines([{text: 'Record Not Found', cls:'white'}, {text: `No registration matches ${email}`, cls:'white'}], () => {});
      console.log("Displayed not found for", email);
    }

    // main search
    async function doSearch(rawEmail){
      const email = formatEmail(rawEmail);
      if(!email){
        alert('Please enter an email address.');
        return;
      }
      const found = await simulateLookup(email);
      if(found){
        renderProfile(found);
      }else{
        renderNotFound(email);
      }
    }

    // event listeners
    searchBtn.addEventListener('click', () => {
      const v = emailInput.value;
      doSearch(v);
    });

    resetBtn.addEventListener('click', () => {
      emailInput.value = '';
      profileCard.style.display = 'none';
      invoiceCard.style.display = 'none';
      actionButtons.style.display = 'none';
    });

    // Mark Payment -> prompt for amount + ref, update local data & UI
    markPaymentBtn.addEventListener('click', () => {
      const email = formatEmail(emailInput.value);
      if(!email) { alert('Enter email first.'); return; }
      const user = db.find(r => r.email.toLowerCase() === email.toLowerCase());
      if(!user){ alert('No record to mark payment for.'); return; }
      const amtRaw = prompt('Enter payment amount (USD):', '');
      if(!amtRaw) return;
      const amt = parseFloat(amtRaw);
      if(isNaN(amt) || amt <= 0) { alert('Invalid amount'); return; }
      const ref = prompt('Enter payment reference:', 'transfer') || 'transfer';
      const date = new Date().toISOString().split('T')[0];
      user.payments.push({date, amount: amt, ref});
      user.amountPaid = (user.amountPaid || 0) + amt;
      user.balance = Math.max(0, (user.subtotal || 0) - user.amountPaid);
      user.paymentRef = ref;
      saveData(db);
      console.log("Marked payment:", {email: user.email, amount: amt, ref});
      renderProfile(user);
      // show success modal briefly
      showModal('Payment Recorded', `Payment of ${dollar(amt)} recorded. New balance ${dollar(user.balance)}.`);
    });

    // Generate Class Private Link
    generateLinkBtn.addEventListener('click', () => {
      const email = formatEmail(emailInput.value);
      if(!email) { alert('Enter email first.'); return; }
      const user = db.find(r => r.email.toLowerCase() === email.toLowerCase());
      if(!user){ alert('No registration found.'); return; }
      if(user.balance > 0){
        // show styled modal asking to clear outstanding
        showModal('Access Restricted', `⚠️ Please clear outstanding of ${dollar(user.balance)} to access the class.`, {showCopy:false});
        console.log("Generate link blocked — balance > 0 for", user.email, user.balance);
      }else{
        const nameSlug = user.name.toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,30);
        const batchSlug = (user.batch || 'class').toLowerCase().replace(/\s+/g,'');
        const link = `https://nextgencyberclass.com/classroom/${batchSlug}/${nameSlug}`;
        showModal('Access Granted', `✅ Your private link:\n\n${link}`, {showCopy:true, link});
        console.log("Generated class link for", user.email, link);
      }
    });

    // Modal functions
    function showModal(title, body, opts={showCopy:false, link:null}){
      modalTitle.textContent = title;
      modalBody.textContent = body;
      modalBackdrop.style.display = 'flex';
      setTimeout(()=> modal.classList.add('show'), 10);
      modalBackdrop.setAttribute('aria-hidden','false');
      modalCopyLink.style.display = opts.showCopy ? '' : 'none';
      modalCopyLink.dataset.link = opts.link || '';
      modalCopyLink.focus();
    }
    function closeModal(){
      modal.classList.remove('show');
      setTimeout(()=> {
        modalBackdrop.style.display = 'none';
        modalBackdrop.setAttribute('aria-hidden','true');
      }, 180);
    }
    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if(e.target === modalBackdrop) closeModal();
    });
    modalCopyLink.addEventListener('click', () => {
      const link = modalCopyLink.dataset.link;
      if(!link) return;
      navigator.clipboard.writeText(link).then(() => {
        showModal('Link Copied', 'Private link copied to clipboard.');
        console.log('Copied link to clipboard:', link);
      }).catch(()=> alert('Copy failed'));
    });

    // Copy info to clipboard
    copyBtn.addEventListener('click', () => {
      const email = formatEmail(emailInput.value);
      const user = db.find(r => r.email.toLowerCase() === email.toLowerCase());
      if(!user){ alert('No record found to copy'); return; }
      const payload = {
        name: user.name, email: user.email, phone: user.phone, batch: user.batch,
        amountPaid: user.amountPaid, balance: user.balance, items: user.items
      };
      const text = `NextGen Cyber Institute VIP — Registration\n` + JSON.stringify(payload, null, 2);
      navigator.clipboard.writeText(text).then(()=> {
        showModal('Copied', 'Registration info copied to clipboard.');
        console.log('Copied registration info for', user.email);
      }).catch(()=> alert('Copy to clipboard failed'));
    });

    // Print
    printBtn.addEventListener('click', () => {
      window.print();
      console.log('Print dialog opened');
    });

    // Chat admin (opens WhatsApp to admin number) - update with your admin number if needed
    chatBtn.addEventListener('click', () => {
      // admin phone (example)
      const adminNumber = '+27644746298';
      const url = `https://wa.me/${adminNumber.replace(/\D/g,'')}`;
      window.open(url, '_blank');
      console.log('Opening WhatsApp to admin:', adminNumber);
    });

    // Export CSV
    exportBtn.addEventListener('click', () => {
      const data = db;
      const csvRows = [];
      csvRows.push(['name','email','phone','batch','amountPaid','balance','interest','source'].join(','));
      data.forEach(d => {
        csvRows.push([
          `"${d.name.replace(/"/g,'""')}"`,
          d.email,
          d.phone,
          d.batch,
          d.amountPaid,
          d.balance,
          `"${(d.interest||'').replace(/"/g,'""')}"`,
          d.source
        ].join(','));
      });
      const csv = csvRows.join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ngci_registrations.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      console.log('Exported CSV for', data.length, 'records');
      showModal('Exported', 'CSV exported locally (check downloads).');
    });

    // initial small hint
    console.log("Ready. Preloaded records:", db);

    // If user presses Enter in email input, run search
    emailInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') searchBtn.click();
    });

    // small auto-format on blur
    emailInput.addEventListener('blur', () => {
      emailInput.value = formatEmail(emailInput.value);
    });

  
    // Optional: auto-run search for the prefill (comment/uncomment as desired)
    // doSearch(phoneInput.value);

    // Static start date: write today's date into the header element
    (function showTodayDate(){
      const el = document.getElementById('startDate');
      if(!el) return;
      const now = new Date();
      const opts = { year: 'numeric', month: 'short', day: 'numeric' };
      el.textContent = now.toLocaleDateString(undefined, opts);
    })();

    // ready message
    console.log("NGCI portal loaded - enter a WhatsApp number and click 'Check Registration'.");

  </script>
</body>
</html>
